StatefulSet - это объект Kubernetes, который обеспечивает гарантированное управление состоянием приложений, требующих сохранения состояния. Он особенно полезен для развертывания таких приложений, как базы данных, системы очередей сообщений и т. д. StatefulSet гарантирует порядок развертывания и масштабирования подов, а также предоставляет уникальные имена и постоянные сетевые идентификаторы для каждого пода.

Пример манифеста StatefulSet:
<pre><code>
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-mongodb-statefulset
spec:
  serviceName: "mongodb"
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:4.2
        ports:
        - containerPort: 27017
          name: mongodb
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "my-storage-class"
      resources:
        requests:
          storage: 1Gi</code></pre>

В этом примере создается StatefulSet для развертывания MongoDB с тремя репликами. StatefulSet гарантирует, что каждый под получит уникальное имя вида my-mongodb-statefulset-0, my-mongodb-statefulset-1, my-mongodb-statefulset-2, и так далее. Также в примере определены шаблоны объемов (volumeClaimTemplates), которые создают постоянные тома (PersistentVolumeClaim) для каждого пода, обеспечивая сохранение данных между перезапусками.

Основные особенности StatefulSet:

Стабильные сетевые идентификаторы: Каждый под, созданный в рамках StatefulSet, имеет уникальное и стабильное имя, которое основано на индексе. Это позволяет приложениям опираться на стабильные сетевые адреса для связи между подами.

Упорядоченное развертывание и масштабирование: StatefulSet гарантирует, что поды создаются и удаляются в строгом порядке. Это обеспечивает корректную инициализацию и завершение работы приложений, зависящих от порядка.

Упорядоченное обновление: StatefulSet обеспечивает пошаговое обновление подов, что позволяет гарантировать сохранение данных и предотвратить потерю данных при обновлении.

Постоянные тома: StatefulSet позволяет использовать постоянные тома (Persistent Volumes) для хранения данных, что обеспечивает сохранение данных между перезапусками подов. Когда под удаляется, его постоянный том сохраняется и может быть снова присоединен к новому поду при его создании.

Управление состоянием приложения: StatefulSet поддерживает операции, специфичные для приложений с состоянием, такие как гарантированное сохранение состояния приложения при обновлении, перезапуске или масштабировании.

Пример использования StatefulSet:

Предположим, у вас есть приложение, состоящее из веб-сервера и базы данных. Веб-сервер является stateless, и его можно развернуть с помощью Deployment. Однако база данных требует сохранения состояния, и для этого подходит StatefulSet. В этом случае вы можете использовать StatefulSet для развертывания базы данных с несколькими репликами, гарантируя стабильные сетевые идентификаторы и постоянные тома для хранения данных.

Важно помнить, что StatefulSet не является решением для всех сценариев развертывания с сохранением состояния. В некоторых случаях, вам может потребоваться использовать другие объекты Kubernetes, такие как DaemonSet или Custom Resources, в зависимости от вашей архитектуры и требований к приложению.
